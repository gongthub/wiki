# Java 线程详解
## Java线程：概念与原理
### 进程与线程
    进程是指一个内存中运行的应用程序，每个进程都有自己独立的一块内存空间，即进程空间或（虚空间）。进程不依赖于线程而独立存在，一个进程中可以启动多个线程。比如Windows系统中，一个运行的exe就是一个进程。    
    线程是指进程中的一个执行流程，一个进程中可以运行多个线程。比如java.exe进程中可以运行很多线程。线程总是属于某个进程，现在没有自己的虚拟地址空间，与进程内的其他线程一起共享分配给该进程的所有资源。  
    “同时”执行是人的感觉，在线程之间实际上轮换执行。    
    进程在执行过程中拥有独立的内存单元，进程有独立的地址空间，而多个线程共享内存，从而极大地提高了程序的运行效率。  
    线程在执行过程中与进程还是有区别的。每个独立的线程有一个程序运行的入口、顺序执行序列和程序的出口。但是线程不能够独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。    
    进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动，进程是系统进程资源分配和调度的一个独立单位。  
    线程是进程的一个实体，是CPU调度和分派的基本单位，它是比进程更小的能独立运行的基本单位。线程自己基本上不拥有系统资源，只拥有一点在运行中必不可少的资源（如程序计数器，一组寄存器和栈），但是它可与同属一个进程的其他线程共享进程拥有的全部资源。 
    线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个线程包以下内容：  
    - 一个指向当前被执行指令的指令指针。
    - 一个栈。
    - 一个寄存器值的集合，定义了一部分描述正在执行线程的处理器状态的值
    - 一个私有的数据区

        简而言之：     
    - 一个线程至少有一个进程，一个进程至少有一个进程。
    - 线程的划分尺度小于进程，是的多线程程序的并发性高。
    - 进程在执行过程中拥有独立的内存单元，而多个线程共享内存，从而极大地提高了程序的运行效率
    - 线程在执行过程中与进程还是有区别的。每个独立的线程有一个程序运行的入口、顺序执行序列和程序的出口。但是线程不能够独立执行，必须依存在应用程序中，由应用程序提供多个线程执行控制。
    - 从逻辑角度来看，多线程的意义在于一个应用程序中，有多个执行部分可以同时执行。但操作系统并没有多个线程看做多个独立的应用，来实现进程的调度和管理以及资源分配。这就是进程和线程的重要区别。
    
### 操作系统线程
![线程状态图](https://raw.githubusercontent.com/gongthub/wiki/master/docs/Resources/%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81%E5%9B%BE.png)
1. 新建状态（New）：线程对象被创建后，就进入了新建状态
2. 就绪状态（Runnable）：也被称为“可执行状态”。线程对象被创建后，其他线程调用了该对象的start()方法，从而来启动线程
3. 运行状态（Running）：线程获取CPU权限进行执行。需要注意的是，线程只能从就绪状态进入到运行状态。
4. 阻塞状态（Blocked）：阻塞状态是线程因为某种原因放弃CPU使用权，暂时停止运行。直到线程进入就绪状态，才有机会转到运行状态。阻塞的情况分为三种：
    - 等待阻塞：通过调用线程的wait()方法，让线程等待某工作的完成。
    - 同步阻塞：线程在获取synchronized同步锁失败（因为锁被其他线程所占用），它会进入同步阻塞状态。
    - 其他阻塞：通过调用线程的sleep()或join()或发出I/O请求时，线程会进入到阻塞状态。当sleep()状态超时、join()等待线程终止或者超时、或者I/O处理完毕时，线程重新转入到就绪状态。
5. 死亡状态（Dead）：线程执行完了或者因异常退出了run()方法，该线程结束生命周期。

### Java中的线程
在Java中，“线程”指两件不同的事情：
- java.lang.Thread类的一个实例
- 线程的执行   
在Java程序中，有两种方法创建线程：
- 对Thread类进行派生并覆盖run方法
- 通过实现Runable接口创建
线程总体分为两类：用户线程和守候线程    
当所有用户线程执行完毕的时候，JVM自动关闭。但是守候线程却不独立于JVM，守候线程一般是由操作系统或用户自己创建的。    
在Java中，每次程序运行至少启动2个线程：一个是main线程，一个是垃圾收集线程。因为每当使用java命令执行一个类的时候，实际上都会启动一个JVM，每个JVM实际上就是在操作系统中启动了一个进程。

Java中的线程状态分为6种
```
1. 初始（NEW）：新创建了一个线程对象，但还没有调用start()方法
2. 运行（RUNNABLE）：Java线程种将就绪（ready）和运行中（running）两种状态笼统的称为“运行”。线程对象创建后，其他线程（比如main线程）调用了该对象的start()方法。该状态的线程位于可运行线程池中，等待被线程调度选中，获取CPU的使用权限，此时处于就绪状态（ready）。就绪状态的线程在获得CPU时间片后变为运行中状态（running）。
3. 阻塞（BLOCKED）：表示线程阻塞于锁。
4. 等待（WAITING）：进入该状态的线程需要等待其他线程做出一些特定动作（通知或中断）。
5. 超时等待（TIMED_WAITING）：该状态不同于WAITING，它可以在指定的时间后自行返回。
6. 终止（TERMINATED）：表示该线程已经执行完毕。
```
1. 初始状态
实现Runnable接口和继承Thread可以得到一个线程类，new一个实例出来，线程就进入了初始状态。
2. - 就绪状态
    1. 就绪状态只是说你有资格运行，调度程序没有挑选到你，你就永远是就绪状态。
    2. 调用线程的start()方法，此线程进入就绪状态
    3. 当线程sleep()方法结束，其他线程join()结束，等待用户输入完毕，某个线程拿到对象锁，这些线程也将进入就绪状态。
    4. 当前线程时间片用完了，调用当前线程的yield()方法，当前线程进入就绪状态。
    5. 锁池里的线程拿到对象锁后，进入就绪状态。

    - 运行中状态    
    线程调度程序从可运行池中选择一个线程作为当前线程时线程所处的状态。这也是线程进入运行状态的唯一一种方式。
3. 阻塞状态
阻塞状态是线程阻塞在进入synchrongized关键字修饰的方法或代码块（获取锁）时的状态
4. 等待
处于这种状态的线程不会被分配CPU执行时间，它们要等待被显示地唤醒，否则会处于无限期等待的状态。
5. 超时等待
处于这种状态的线程不会被分配CPU执行时间，不过无须无限期等待被其他线程显示地唤醒，在达到一定时间后它们会自动唤醒。
5. 终止状态
    1. 当线程的run()方法完成时，或者主线程的main()方法完成时，我们就认为它终止了。这个线程对象也许是活的，但是，它已经不是一个单独执行的线程。线程一旦终止了，就不能复生。
    2. 在一个终止的线程上调用start()方法，会抛出java.lang.IllegalThreadStateException异常。
